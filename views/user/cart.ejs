<%- include('header') %>

<main class="main">
  <div class="page-header breadcrumb-wrap">
    <div class="container">
      <div class="breadcrumb">
        <a href="index.html" rel="nofollow">Home</a>
        <span></span> Shop <span></span> Your Cart
      </div>
    </div>
  </div>
  <section class="mt-50 mb-50">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <div class="table-responsive">
            <table class="table shopping-summery text-center clean">
              <thead>
                <tr class="main-heading">
                  <th scope="col">Image</th>
                  <th scope="col">Name</th>
                  <th scope="col">Price</th>
                  <th scope="col">Quantity</th>
                  <th scope="col">Subtotal</th>
                  <th scope="col">Remove</th>
                </tr>
              </thead>
              <tbody>
                <% if (product.length> 0) { %>
                    
                    <% for (let i=0; i < product.length;i++) { %>

                <!-- ---------------------this is the cart item ------------------------ -->
                <tr>
                  <td class="image product-thumbnail">
                      <img src="/admin/assets/imgs/catogary/<%= product[i].images[0] %>" alt="#" />
                  </td>
                  <td class="product-des product-name">
                      <h5 class="product-name">
                          <a href="shop-product-right.html"><%= product[i].title %></a>
                      </h5>
                      <p class="font-xs">
                          <%= product[i].catogary %><br />
                          <%= product[i].brand %>.
                      </p>
                  </td>
                  <td class="price" data-title="Price"><span>$ <%= product[i].price %> </span></td>
                  <td class="text-center" data-title="Stock">
                      <div class="detail-qty border radius m-auto">
                          <div class="quantity-control">
                              <button class="btn btn-sm increment-button" onclick="test('<%= product[i]._id %>','<%= cart[i].quantity %>',1,'<%= product[i].price %>')">+</button>

                              <!-- <button class="btn btn-sm increment-button" onclick="changeQty('<%= user._id %>', '<%= product[i]._id %>', 1, '<%= i %>')">+</button> -->
                              <input class="quantity-input" id="cartProductqty" style="width: 45px;" type="text" readonly value="<%= cart[i].quantity %>" data-product-index="<%= i %>">
                              <button class="btn btn-sm decrement-button" onclick="changeQty('<%= user._id %>', '<%= product[i]._id %>', -1, '<%= i %>')">-</button>
                          </div>
                      </div>
                  </td>
                  <!-- Span with a unique ID -->
                  <td class="text-right" data-title="Cart">
                      <span id="subtotal">$<%= product[i].price * cart[i].quantity %></span>
                  </td>
                  <td class="action" data-title="Remove">
                      <a href="#" class="text-muted" onclick="removeCartItem('<%= product[i]._id %>')"><i class="fi-rs-trash"></i></a>
                  </td>
                  
                <!-- -----------------------cart item text-end---------------------- -->

                <% } %> 
                <% } else { %>
                <tr>
                  <td colspan="2">No item found in Cart</td>
                </tr>
                <% } %>

                <tr>
                  <td colspan="6" class="text-end">
                    <a href="#" class="text-muted">
                      <i class="fi-rs-cross-small"></i> Clear Cart</a
                    >
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="cart-action text-end">
            <a class="btn mr-10 mb-sm-15"
              ><i class="fi-rs-shuffle mr-10"></i>Update Cart</a
            >
            <a class="btn"
              ><i class="fi-rs-shopping-bag mr-10"></i>Continue Shopping</a
            >
          </div>
          <div class="divider center_icon mt-50 mb-50">
            <i class="fi-rs-fingerprint"></i>
          </div>
          <div class="row mb-50">
            <div class="col-lg-6 col-md-12">
              <div class="heading_s1 mb-3">
                <h4>Calculate Shipping</h4>
              </div>
              <p class="mt-15 mb-30">
                Flat rate: <span class="font-xl text-brand fw-900">5%</span>
              </p>
              <form class="field_form shipping_calculator">
                <div class="form-row">
                  <div class="form-group col-lg-12">
                    <div class="custom_select">
                      <select class="form-control select-active">
                        <option value="">Choose a option...</option>
                        <option value="AX">Aland Islands</option>
                        <option value="AF">Afghanistan</option>
                        <option value="AL">Albania</option>
                        <option value="DZ">Algeria</option>
                      
                        <option value="ZM">Zambia</option>
                        <option value="ZW">Zimbabwe</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="form-row row">
                  <div class="form-group col-lg-6">
                    <input
                      required="required"
                      placeholder="State / Country"
                      name="name"
                      type="text"
                    />
                  </div>
                  <div class="form-group col-lg-6">
                    <input
                      required="required"
                      placeholder="PostCode / ZIP"
                      name="name"
                      type="text"
                    />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-lg-12">
                    <button class="btn btn-sm">
                      <i class="fi-rs-shuffle mr-10"></i>Update
                    </button>
                  </div>
                </div>
              </form>
              <div class="mb-30 mt-50">
                <div class="heading_s1 mb-3">
                  <h4>Apply Coupon</h4>
                </div>
                <div class="total-amount">
                  <div class="left">
                    <div class="coupon">
                      <form action="#" target="_blank">
                        <div class="form-row row justify-content-center">
                          <div class="form-group col-lg-6">
                            <input
                              class="font-medium"
                              name="Coupon"
                              placeholder="Enter Your Coupon"
                            />
                          </div>
                          <div class="form-group col-lg-6">
                            <button class="btn btn-sm">
                              <i class="fi-rs-label mr-10"></i>Apply
                            </button>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-6 col-md-12">
              <div class="border p-md-4 p-30 border-radius cart-totals">
                <div class="heading_s1 mb-3">
                  <h4>Cart Totals</h4>
                </div>
                <div class="table-responsive">
                  <table class="table">
                    <tbody>
                      <tr>
                        <td class="cart_total_label">Cart Subtotal</td>
                        <td class="cart_total_amount">
                          <span class="font-lg fw-900 text-brand">$<%= totalSubTotal %></span>
                        </td>
                      </tr>
                      <tr>
                        <td class="cart_total_label">Shipping</td>
                        <td class="cart_total_amount">
                          <i class="ti-gift mr-5"></i> Free Shipping
                        </td>
                      </tr>
                      <tr>
                        <td class="cart_total_label">Total</td>
                        <td class="cart_total_amount">
                          <strong
                            ><span class="font-xl fw-900 text-brand"
                              >$<%= totalSubTotal %></span
                            ></strong
                          >
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <a href="#" class="btn">
                  <i class="fi-rs-box-alt mr-10"></i> Proceed To CheckOut</a
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
function test(productId, cartQty, count, prPrice) {
    $.ajax({
        url: '/api/user/test',
        method: 'POST',
        data: {
            productId: productId,
            cartQty: cartQty,
            count: count
        },
        success: function (response) {
            console.log(response, "response is this");
            if (response.status) {
                // alert("iam here with success");

                // Update the cart quantity input field
                const cartProductQtyElement = document.querySelector(`input[data-product-index="${i}"]`)
                cartProductQtyElement.value = response.quantityInput;

                // Calculate and update the subtotal based on the new quantity and price
                const newQuantity = response.quantityInput;
                const subtotal = newQuantity * prPrice;
                const subtotalElement = document.querySelector(`#subtotal${i}`);
                subtotalElement.innerHTML = `$${subtotal.toFixed(2)}`;
            }
        },
        error: function (error) {
            alert("iam here with error");
        }
    });
}



    function changeQty(userId, productId, change, index) {
        const quantityInput = document.getElementById(`quantity-input-${index}`);
        console.log('hello');
        const currentQuantity = parseInt(quantityInput.value);
        const newQuantity = currentQuantity + change;

        if (newQuantity < 1) {
            return; // Ensure quantity doesn't go below 1.
        }

        $.ajax({
            url: '/change-cart-item-quantity',
            data: {
                userId: userId,
                productId: productId,
                newQuantity: newQuantity
            },
            method: 'POST',
            success: function(response) {
                if (response.status) {
                    // Update quantity input field
                    quantityInput.value = newQuantity;

                    // Update item subtotal
                    const itemSubTotalId = `itemSubTotal${index}`;
                    const itemPrice = product[i].price  ;
                    $(`#${itemSubTotalId}`).text(`$${itemPrice * newQuantity}`);

                    // You may need to update the cart total and other relevant elements here.
                } else {
                    alert("Unable to update quantity.");
                }
            },
            error: function() {
                alert("Unable to update quantity.");
            }
        });
    }

    function removeCartItem(productId) {
        // Handle cart item removal here using AJAX if needed.
    }




//========================================================================
// function changeQuantity(userId, proId, count, unit) {

// let quantity = document.getElementById(proId).value
// quantity = parseInt(quantity)
// if (unit < quantity + 1) {

// let quantity = document.getElementById(proId).value;
// quantity = parseInt(quantity)
// unit = parseInt(unit)
// if (quantity + 1 > unit) {
//   Swal.fire({
//     title: 'STOCK!',
//     text: 'Product is out of stock.',
//     icon: 'error',
//     timer: 5000
//   })

// }

// }
// else {

// let proTotal = document.getElementById(proId + 'pro-total').innerHTML;
// let price = document.getElementById(proId + 'price').innerHTML;
// proTotal = parseInt(proTotal);
// price = parseInt(price);
// if (count == 1) {
//   document.getElementById(proId + 'pro-total').innerHTML = proTotal + price
//   price = document.getElementById(proId + 'price').innerHTML;
//   let GrandTotal = document.getElementById('grand-total').innerHTML
//   document.getElementById('grand-total').innerHTML = parseInt(GrandTotal) + parseInt(price);
// } else if (quantity > 1) {
//   document.getElementById(proId + 'pro-total').innerHTML = proTotal - price
//   price = document.getElementById(proId + 'price').innerHTML;
//   let GrandTotal = document.getElementById('grand-total').innerHTML
//   document.getElementById('grand-total').innerHTML = parseInt(GrandTotal) - parseInt(price);
// }



// $.ajax({
//   url: "/change-quantity",
//   method: 'post',
//   data: {
//     userId: userId,
//     proId: proId,
//     count: count,
//     quantity: quantity,
//   },
//   success: (response) => {
//     console.log(response.status)
//     if (response.status == true) {
//       location.reload();
//     } else {
//       let total = parseInt(quantity) + parseInt(count);
//       document.getElementById(proId).value = total;

//     }
//   }
// })
// }
// }
//=====================>>>>>>>>>>>>>>>>>>>>fech methord <<<<<<<<<<<<<<<<<<<<<<<<<<<<<===========
  // Get references to all increment and decrement buttons
// const incrementButtons = document.querySelectorAll('.increment-button');
// const decrementButtons = document.querySelectorAll('.decrement-button');
// const quantityInputs = document.querySelectorAll('.quantity-input');
// const cartTotalSpans = document.querySelectorAll('.cart-total-span');

// // Attach click event listeners to the buttons
// incrementButtons.forEach((button) => {
//   button.addEventListener('click', () => {
//     handleIncrement(button);
//   });
// });

// decrementButtons.forEach((button) => {
//   button.addEventListener('click', () => {
//     handleDecrement(button);
//   });
// });

// // Function to handle incrementing the quantity
// function handleIncrement(button) {
//   const productIndex = button.getAttribute('data-product-index');
//   const quantityInput = quantityInputs[productIndex];
//   const cartTotalSpan = cartTotalSpans[productIndex];

//   // Increment the quantity input value
//   const currentQuantity = parseInt(quantityInput.value);
//   quantityInput.value = currentQuantity + 1;

//   // Update the cart total span
//   const productPrice = parseFloat(cartTotalSpan.textContent.replace('$', ''));
//   const newTotal = (currentQuantity + 1) * productPrice;
//   cartTotalSpan.textContent = `$${newTotal.toFixed(2)}`;

//   // Send an AJAX/Fetch request to update the server if needed
//   // ...
// }

// // Function to handle decrementing the quantity
// function handleDecrement(button) {
//   const productIndex = button.getAttribute('data-product-index');
//   const quantityInput = quantityInputs[productIndex];
//   const cartTotalSpan = cartTotalSpans[productIndex];

//   // Ensure the quantity is greater than 1 before decrementing
//   const currentQuantity = parseInt(quantityInput.value);
//   if (currentQuantity > 1) {
//     quantityInput.value = currentQuantity - 1;

//     // Update the cart total span
//     const productPrice = parseFloat(cartTotalSpan.textContent.replace('$', ''));
//     const newTotal = Math.ceil((currentQuantity - 1) * productPrice);
//     console.log('newTotal Ids ""',newTotal);
//     cartTotalSpan.textContent = `$${newTotal.toFixed(2)}`;

    // Send an AJAX/Fetch request to update the server if needed
    // ...
  // }
// }
//================>>>>>>>>>>>>>>>>>>>>>>>fecth methorf end<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<+=====================
</script>




<!-- Your JavaScript code -->

  

<%- include('footer') %>
